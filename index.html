<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MiniBoleta Â· PWA</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#000000"/>
  <style>
    :root { --spacing: 12px; --accent: #000; --bg:#f8f9fb; --card:#fff; --border:#e4e6eb; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: var(--bg); color: #111; }
    header { position: sticky; top: 0; background: var(--card); border-bottom:1px solid var(--border); padding: var(--spacing); display:flex; align-items:center; gap:8px; z-index:10;}
    header h1{ font-size:18px; margin:0; }
    nav { display:flex; gap:8px; margin-left:auto; }
    nav button { padding:8px 12px; border:1px solid var(--border); background:#fff; border-radius:10px; }
    .container{ padding: var(--spacing); max-width: 900px; margin: 0 auto; }
    .card{ background: var(--card); border:1px solid var(--border); border-radius:16px; padding:var(--spacing); margin-bottom: var(--spacing); }
    label{ font-size:14px; color:#333; display:block; margin-bottom:4px; }
    input, select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; }
    table{ width:100%; border-collapse: collapse; font-size:14px; }
    th, td{ padding:8px; border-bottom:1px solid var(--border); text-align:left; }
    tfoot td{ font-weight:600; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap: var(--spacing); }
    .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap: var(--spacing); }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; }
    .btn.primary{ background: var(--accent); color:#fff; border-color: var(--accent); }
    .hidden{ display:none !important; }
    .right{ text-align:right; }
    .danger{ color:#c00; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#fafafa; }
    @media (max-width:700px){ .row,.row3{ grid-template-columns:1fr; } }
    /* Print styles: show only printable receipt */
    @media print {
      body { background:#fff; }
      header, nav, #view-venta, #view-historial, #view-admin { display:none !important; }
      #printable { display:block !important; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ§¾ MiniBoleta</h1>
    <nav>
      <button onclick="showView('venta')">Venta</button>
      <button onclick="showView('historial')">Historial</button>
      <button onclick="showView('admin')">Admin</button>
    </nav>
  </header>

  <div class="container">
    <!-- VENTA -->
    <section id="view-venta" class="card">
      <h2>Nueva venta</h2>
      <div class="row">
        <div>
          <label>Cliente</label>
          <input id="cliente" placeholder="Nombre del cliente">
        </div>
        <div>
          <label>Fecha</label>
          <input id="fecha" type="date">
        </div>
      </div>
      <div class="row3" style="margin-top:var(--spacing);">
        <div>
          <label>Producto</label>
          <select id="producto"></select>
        </div>
        <div>
          <label>Cantidad</label>
          <input id="cantidad" type="number" min="1" value="1">
        </div>
        <div style="align-self:end;">
          <button class="btn" onclick="addItem()">Agregar</button>
        </div>
      </div>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Producto</th><th class="right">Precio unitario</th><th class="right">Cantidad</th><th class="right">Subtotal</th><th></th>
            </tr>
          </thead>
          <tbody id="items"></tbody>
          <tfoot>
            <tr><td colspan="3" class="right">Neto</td><td class="right mono" id="neto">$0</td><td></td></tr>
            <tr><td colspan="3" class="right">IVA (<span id="iva-rate">19</span>%)</td><td class="right mono" id="iva">$0</td><td></td></tr>
            <tr><td colspan="3" class="right">Total (Bruto)</td><td class="right mono" id="total">$0</td><td></td></tr>
          </tfoot>
        </table>
        <div class="actions" style="margin-top:8px;">
          <button class="btn" onclick="resetVenta()">Limpiar</button>
          <button class="btn primary" onclick="saveAndPrint()">Guardar & Imprimir</button>
        </div>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section id="view-historial" class="card hidden">
      <h2>Historial</h2>
      <div class="row">
        <div>
          <label>Buscar por cliente o correlativo</label>
          <input id="search" placeholder="Ej: Juan PÃ©rez o 000123" oninput="renderHistorial()">
        </div>
        <div style="align-self:end;">
          <span class="pill" id="count"></span>
        </div>
      </div>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Correlativo</th><th>Fecha</th><th>Cliente</th><th class="right">Total</th><th></th>
            </tr>
          </thead>
          <tbody id="historial"></tbody>
        </table>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="card hidden">
      <h2>Admin</h2>
      <div id="admin-locked">
        <label>PIN de admin</label>
        <div class="actions">
          <input id="pin" type="password" placeholder="1234" style="max-width:200px;">
          <button class="btn" onclick="unlock()">Entrar</button>
        </div>
      </div>
      <div id="admin-panel" class="hidden">
        <div class="row">
          <div class="card">
            <h3>Productos</h3>
            <div class="row3">
              <input id="prod-nombre" placeholder="Nombre producto">
              <input id="prod-precio" type="number" min="0" placeholder="Precio CLP">
              <button class="btn" onclick="addProducto()">Agregar</button>
            </div>
            <table style="margin-top:8px;">
              <thead><tr><th>Producto</th><th class="right">Precio</th><th></th></tr></thead>
              <tbody id="productos-table"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>ParÃ¡metros</h3>
            <label>IVA (%)</label>
            <input id="iva-input" type="number" min="0" max="100" value="19" style="max-width:120px;">
            <label style="margin-top:8px;">Cambiar PIN</label>
            <div class="row3">
              <input id="pin1" type="password" placeholder="Nuevo PIN">
              <input id="pin2" type="password" placeholder="Repetir PIN">
              <button class="btn" onclick="changePIN()">Guardar PIN</button>
            </div>
            <div class="actions" style="margin-top:8px;">
              <button class="btn" onclick="exportBackup()">Exportar respaldo</button>
              <label class="btn">
                Importar respaldo
                <input id="import-file" type="file" accept=".json" style="display:none" onchange="importBackup(this.files[0])">
              </label>
              <button class="btn danger" onclick="resetTodo()">Borrar TODO</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Printable receipt -->
    <section id="printable" class="card hidden">
      <div id="receipt"></div>
    </section>
  </div>

  <script>
    // --- Utilities ---
    const $ = (id)=>document.getElementById(id);
    const fmt = new Intl.NumberFormat('es-CL',{ style:'currency', currency:'CLP', maximumFractionDigits:0 });

    const store = {
      get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def } catch{ return def } },
      set(key, val){ localStorage.setItem(key, JSON.stringify(val)); },
      remove(key){ localStorage.removeItem(key); }
    };

    const state = {
      items: []
    };

    const defaults = {
      productos: [
        { id: crypto.randomUUID(), nombre: "Arroz 1kg", precio: 1500 },
        { id: crypto.randomUUID(), nombre: "Aceite 1L", precio: 2800 },
        { id: crypto.randomUUID(), nombre: "Fideos 400g", precio: 1200 },
        { id: crypto.randomUUID(), nombre: "AzÃºcar 1kg", precio: 1400 }
      ],
      ventas: [],
      nextCorrelativo: 1,
      iva: 19,
      pin: "1234"
    };

    function init(){
      // Boot data
      for (const [k,v] of Object.entries(defaults)){
        if (store.get(k) == null) store.set(k, v);
      }
      // Seed UI
      $('fecha').valueAsNumber = Date.now() - (new Date().getTimezoneOffset()*60000);
      renderProductosSelect();
      renderItems();
      renderHistorial();
      $('iva-rate').textContent = store.get('iva', 19);

      // PWA install
      if ('serviceWorker' in navigator){
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      }
    }

    function showView(id){
      for (const v of ['venta','historial','admin']){
        $('view-'+v).classList.toggle('hidden', v!==id);
      }
      if (id==='historial') renderHistorial();
    }

    // --- Venta ---
    function renderProductosSelect(){
      const productos = store.get('productos', []);
      const sel = $('producto');
      sel.innerHTML = '';
      productos.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.nombre} â€” ${fmt.format(p.precio)}`;
        sel.appendChild(opt);
      });
    }

    function addItem(){
      const productos = store.get('productos', []);
      const id = $('producto').value;
      const cantidad = Math.max(1, parseInt($('cantidad').value || '1', 10));
      const prod = productos.find(p=>p.id===id);
      if (!prod) return alert('Producto no encontrado');
      const item = { id: crypto.randomUUID(), productoId: id, nombre: prod.nombre, precio: prod.precio, cantidad };
      state.items.push(item);
      renderItems();
    }

    function removeItem(id){
      state.items = state.items.filter(i=>i.id!==id);
      renderItems();
    }

    function calcTotals(){
      const ivaRate = Number(store.get('iva', 19));
      const neto = state.items.reduce((sum,i)=> sum + i.precio * i.cantidad, 0);
      const iva = Math.round(neto * (ivaRate/100));
      const total = neto + iva;
      return { neto, iva, total, ivaRate };
    }

    function renderItems(){
      const tbody = $('items');
      tbody.innerHTML = '';
      state.items.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.nombre}</td>
          <td class="right mono">${fmt.format(it.precio)}</td>
          <td class="right">${it.cantidad}</td>
          <td class="right mono">${fmt.format(it.precio*it.cantidad)}</td>
          <td class="right"><button class="btn" onclick="removeItem('${it.id}')">Quitar</button></td>
        `;
        tbody.appendChild(tr);
      });
      const t = calcTotals();
      $('neto').textContent = fmt.format(t.neto);
      $('iva').textContent = fmt.format(t.iva);
      $('total').textContent = fmt.format(t.total);
      $('iva-rate').textContent = t.ivaRate;
    }

    function resetVenta(){
      state.items = [];
      $('cliente').value = '';
      $('cantidad').value = 1;
      $('fecha').valueAsNumber = Date.now() - (new Date().getTimezoneOffset()*60000);
      renderItems();
    }

    function pad(num, len=6){ return String(num).padStart(len, '0'); }

    function saveAndPrint(){
      if (state.items.length === 0) return alert('Agrega al menos un producto.');
      const cliente = $('cliente').value.trim() || 'Consumidor Final';
      const fecha = $('fecha').value || new Date().toISOString().slice(0,10);

      // Build venta
      const ventas = store.get('ventas', []);
      const next = store.get('nextCorrelativo', 1);
      const correlativo = pad(next);
      const { neto, iva, total, ivaRate } = calcTotals();
      const venta = {
        correlativo,
        fecha,
        cliente,
        items: state.items.map(i=>({ nombre:i.nombre, precio:i.precio, cantidad:i.cantidad })),
        neto, iva, total, ivaRate
      };
      ventas.push(venta);
      store.set('ventas', ventas);
      store.set('nextCorrelativo', next+1);

      // Render receipt and print
      renderReceipt(venta);
      window.print();

      // Reset
      resetVenta();
      alert('Guardado con correlativo ' + correlativo);
    }

    function renderReceipt(v){
      const el = $('receipt');
      const lines = v.items.map(i=>`
        <tr>
          <td>${i.nombre}</td>
          <td class="right mono">${fmt.format(i.precio)}</td>
          <td class="right">${i.cantidad}</td>
          <td class="right mono">${fmt.format(i.precio*i.cantidad)}</td>
        </tr>`).join('');
      el.innerHTML = `
        <div style="max-width:700px;margin:auto;">
          <h2 style="margin:4px 0;">MiniBoleta</h2>
          <div style="display:flex;justify-content:space-between;">
            <div><strong>Cliente:</strong> ${v.cliente}</div>
            <div><strong>Fecha:</strong> ${v.fecha}</div>
          </div>
          <div><strong>Correlativo:</strong> ${v.correlativo}</div>
          <hr/>
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr><th style="text-align:left;">Producto</th><th class="right">P.Unit</th><th class="right">Cant</th><th class="right">Subtotal</th></tr>
            </thead>
            <tbody>${lines}</tbody>
            <tfoot>
              <tr><td colspan="3" class="right">Neto</td><td class="right mono">${fmt.format(v.neto)}</td></tr>
              <tr><td colspan="3" class="right">IVA (${v.ivaRate}%)</td><td class="right mono">${fmt.format(v.iva)}</td></tr>
              <tr><td colspan="3" class="right">Total</td><td class="right mono">${fmt.format(v.total)}</td></tr>
            </tfoot>
          </table>
          <p style="font-size:12px;color:#555;margin-top:8px;">
            Documento no vÃ¡lido como boleta electrÃ³nica del SII. Uso interno.
          </p>
        </div>
      `;
      // Ensure printable section visible for print
      $('printable').classList.remove('hidden');
      setTimeout(()=> $('printable').classList.add('hidden'), 1000);
    }

    // --- Historial ---
    function renderHistorial(){
      const ventas = store.get('ventas', []);
      const q = ($('search').value || '').toLowerCase().trim();
      const tb = $('historial');
      tb.innerHTML = '';
      const filtered = ventas.filter(v=>{
        if (!q) return true;
        return v.cliente.toLowerCase().includes(q) || v.correlativo.includes(q);
      }).sort((a,b)=> b.correlativo.localeCompare(a.correlativo));
      $('count').textContent = `${filtered.length} registros`;
      filtered.forEach(v=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${v.correlativo}</td>
          <td>${v.fecha}</td>
          <td>${v.cliente}</td>
          <td class="right mono">${fmt.format(v.total)}</td>
          <td class="right">
            <button class="btn" onclick='openVenta("${v.correlativo}")'>Abrir</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    function openVenta(correlativo){
      const ventas = store.get('ventas', []);
      const v = ventas.find(x=>x.correlativo===correlativo);
      if (!v) return alert('No encontrada');
      renderReceipt(v);
      // Scroll to top for print preview behavior on phones
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // --- Admin ---
    function unlock(){
      const pin = store.get('pin', '1234');
      const input = $('pin').value;
      if (input === pin){
        $('admin-locked').classList.add('hidden');
        $('admin-panel').classList.remove('hidden');
        renderProductosTable();
        $('iva-input').value = store.get('iva', 19);
      } else {
        alert('PIN incorrecto');
      }
    }

    function renderProductosTable(){
      const productos = store.get('productos', []);
      const tb = $('productos-table');
      tb.innerHTML = '';
      productos.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.nombre}</td>
          <td class="right mono">${fmt.format(p.precio)}</td>
          <td class="right">
            <button class="btn" onclick='editProducto("${p.id}")'>Editar</button>
            <button class="btn danger" onclick='delProducto("${p.id}")'>Eliminar</button>
          </td>`;
        tb.appendChild(tr);
      });
      renderProductosSelect();
    }

    function addProducto(){
      const nombre = $('prod-nombre').value.trim();
      const precio = Number($('prod-precio').value);
      if (!nombre || !(precio >= 0)) return alert('Datos invÃ¡lidos');
      const productos = store.get('productos', []);
      productos.push({ id: crypto.randomUUID(), nombre, precio });
      store.set('productos', productos);
      $('prod-nombre').value = ''; $('prod-precio').value = '';
      renderProductosTable();
    }

    function editProducto(id){
      const productos = store.get('productos', []);
      const p = productos.find(x=>x.id===id); if (!p) return;
      const nuevo = prompt('Nuevo precio CLP para ' + p.nombre, p.precio);
      if (nuevo===null) return;
      const val = Number(nuevo);
      if (!(val>=0)) return alert('Precio invÃ¡lido');
      p.precio = val;
      store.set('productos', productos);
      renderProductosTable();
    }

    function delProducto(id){
      const productos = store.get('productos', []);
      const arr = productos.filter(x=>x.id!==id);
      store.set('productos', arr);
      renderProductosTable();
    }

    function changePIN(){
      const p1 = $('pin1').value, p2 = $('pin2').value;
      if (!p1 || p1!==p2) return alert('PIN no coincide');
      store.set('pin', p1);
      $('pin1').value=''; $('pin2').value='';
      alert('PIN actualizado');
    }

    function exportBackup(){
      const data = {
        productos: store.get('productos', []),
        ventas: store.get('ventas', []),
        nextCorrelativo: store.get('nextCorrelativo', 1),
        iva: store.get('iva', 19),
        pin: store.get('pin', '1234')
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'miniboleta-backup.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importBackup(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const data = JSON.parse(e.target.result);
          for (const k of ['productos','ventas','nextCorrelativo','iva','pin']){
            if (k in data) store.set(k, data[k]);
          }
          alert('ImportaciÃ³n completa');
          renderProductosTable();
          renderProductosSelect();
          renderHistorial();
        }catch(err){ alert('Archivo invÃ¡lido'); }
      };
      reader.readAsText(file);
    }

    function resetTodo(){
      if (!confirm('Esto borrarÃ¡ todo. Â¿Seguro?')) return;
      localStorage.clear();
      init();
      alert('Reiniciado');
    }

    // Persist IVA changes
    $('iva-input')?.addEventListener('change', (e)=>{
      const val = Number(e.target.value || 19);
      store.set('iva', val);
      $('iva-rate').textContent = val;
      renderItems();
    });

    // Init
    init();
  </script>
</body>
</html>
