<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0F172A"/>
  <title>MiniBoleta — Boletas con IVA</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#eef0f4;           /* gris claro fondo app */
      --surface:#ffffff;      /* tarjetas */
      --text:#0b1220;         /* texto */
      --muted:#687182;        /* texto suave */
      --border:#E5E7EB;       /* bordes suaves */
      --pill:#0f172a;         /* pastillas oscuras */
      --pillText:#ffffff;
      --soft:#f3f4f6;         /* inputs */
      --accent:#0f172a;       /* primario */
      --accent-ghost:#d1d5db; /* gris botones secundarios */
      --radius:16px;
      --shadow:0 6px 22px rgba(2,6,23,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial,sans-serif;color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:var(--surface);border-bottom:1px solid var(--border)}
    .wrap{max-width:980px;margin:0 auto;padding:12px 16px}
    h1{margin:2px 0 10px;font-size:20px;font-weight:800}
    nav{display:flex;gap:8px;margin-bottom:8px}
    .tab{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:999px;font-weight:600}
    .tab.active{background:var(--pill);color:var(--pillText);border-color:var(--pill)}
    .container{max-width:980px;margin:0 auto;padding:12px 16px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .search{background:var(--soft)}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){ .row{grid-template-columns:1fr 1fr} }
    .list{display:flex;flex-direction:column;gap:10px}
    .list-item{display:flex;align-items:center;justify-content:space-between;padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff;box-shadow:var(--shadow)}
    .title-sm{font-weight:700}
    .muted{color:var(--muted)}
    .pill-btn{appearance:none;border:1px solid var(--pill);background:var(--pill);color:#fff;border-radius:999px;padding:10px 16px;font-weight:700}
    .pill-btn.ghost{border-color:var(--accent-ghost);background:#f3f4f6;color:#111}
    .totals{padding:10px 0}
    .totals div{display:flex;justify-content:space-between;margin:6px 0}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .cart{min-height:60px}
    .cart-item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{border:1px solid var(--border);background:#fff;border-radius:999px;width:32px;height:32px}
    .right{text-align:right}
    .hidden{display:none !important}
    /* Print */
    @media print{
      header, #view-vender, #view-historial, #view-productos {display:none !important}
      #printable{display:block !important}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Ventas Abarrotes — Boletas con IVA</h1>
      <nav>
        <button class="tab active" id="tab-vender" onclick="showView('vender')">Vender</button>
        <button class="tab" id="tab-historial" onclick="showView('historial')">Historial</button>
        <button class="tab" id="tab-productos" onclick="showView('productos')">Productos</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- VENDER -->
    <section id="view-vender" class="">
      <div class="card">
        <label>Cliente (opcional)</label>
        <input id="cliente" placeholder="Ej: Jorge Díaz">
      </div>

      <div class="card">
        <label>Buscar producto</label>
        <input id="buscar" class="search" placeholder="Ej: arroz, leche, aceite" oninput="renderListaProductos()">
        <div id="productos" class="list" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="title-sm">Carro</div>
        <div id="carro" class="cart muted">Sin productos aún.</div>
      </div>

      <div class="card">
        <div class="totals">
          <div><span>Subtotal:</span><strong id="neto">$0</strong></div>
          <div><span>IVA (<span id="iva-rate">19</span>%):</span><strong id="iva">$0</strong></div>
          <div><span>Total:</span><strong id="total">$0</strong></div>
        </div>
        <div class="btns">
          <button class="pill-btn" onclick="emitir()">Emitir e Imprimir/Guardar</button>
          <button class="pill-btn ghost" onclick="nuevaVenta()">Nueva Venta</button>
        </div>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section id="view-historial" class="hidden">
      <div class="card">
        <label>Buscar por N° o cliente</label>
        <input id="buscarHist" class="search" placeholder="Ej: 123 o Juan" oninput="renderHistorial()">
      </div>
      <div id="historial" class="list"></div>
    </section>

    <!-- PRODUCTOS -->
    <section id="view-productos" class="hidden">
      <div class="card">
        <div class="title-sm" style="margin-bottom:8px;">Nuevo producto</div>
        <div class="row">
          <div>
            <label>Nombre</label>
            <input id="prod-nombre" placeholder="Nombre">
          </div>
          <div>
            <label>Precio</label>
            <input id="prod-precio" type="number" min="0" placeholder="Precio">
          </div>
        </div>
        <div class="btns" style="margin-top:10px;">
          <button class="pill-btn" onclick="agregarProducto()">Agregar</button>
          <button class="pill-btn ghost" onclick="cancelNuevo()">Cancelar</button>
        </div>
      </div>

      <div class="card">
        <div class="title-sm" style="margin-bottom:8px;">Catálogo</div>
        <div id="catalogo" class="list"></div>
      </div>
    </section>

    <!-- Printable -->
    <section id="printable" class="hidden">
      <div id="receipt" class="card"></div>
    </section>
  </main>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt = new Intl.NumberFormat('es-CL',{ style:'currency', currency:'CLP', maximumFractionDigits:0 });

    const store = {
      get(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
    };

    const defaults = {
      iva: 19,
      productos: [
        {id:crypto.randomUUID(), nombre:'Arroz 1kg', precio:1500},
        {id:crypto.randomUUID(), nombre:'Azúcar 1kg', precio:1200},
        {id:crypto.randomUUID(), nombre:'Aceite 1L', precio:3800},
        {id:crypto.randomUUID(), nombre:'Fideos 400g', precio:900},
        {id:crypto.randomUUID(), nombre:'Leche 1L', precio:1100},
      ],
      ventas: [],
      nextCorrelativo: 100
    };

    let carro = []; // {idProd, nombre, precio, qty}

    function init(){
      for (const [k,v] of Object.entries(defaults)){
        if (store.get(k) == null) store.set(k, v);
      }
      $('iva-rate').textContent = store.get('iva',19);
      renderListaProductos();
      renderCarro();
      renderHistorial();
      if ('serviceWorker' in navigator){
        navigator.serviceWorker.register('./service-worker.js');
      }
    }

    function showView(v){
      ['vender','historial','productos'].forEach(x=>{
        $('view-'+x).classList.toggle('hidden', x!==v);
        $('tab-'+x).classList.toggle('active', x===v);
      });
      if (v==='historial') renderHistorial();
      if (v==='productos') renderCatalogo();
    }

    // VENTA
    function renderListaProductos(){
      const q = ($('buscar').value||'').toLowerCase();
      const productos = store.get('productos',[]).filter(p => p.nombre.toLowerCase().includes(q));
      const cont = $('productos');
      cont.innerHTML = '';
      if (productos.length===0){
        cont.innerHTML = '<div class="muted">Sin resultados.</div>';
        return;
      }
      for (const p of productos){
        const li = document.createElement('div');
        li.className = 'list-item';
        li.innerHTML = `<div>
            <div class="title-sm">${p.nombre}</div>
            <div class="muted">${fmt.format(p.precio)}</div>
          </div>
          <button class="pill-btn" onclick="agregarAlCarro('${p.id}')">Agregar</button>`;
        cont.appendChild(li);
      }
    }

    function agregarAlCarro(id){
      const prod = store.get('productos',[]).find(x=>x.id===id);
      if(!prod) return;
      const existente = carro.find(x=>x.idProd===id);
      if (existente){ existente.qty += 1; }
      else { carro.push({ idProd:id, nombre:prod.nombre, precio:prod.precio, qty:1 }); }
      renderCarro();
    }

    function renderCarro(){
      const cont = $('carro');
      if (carro.length===0){ cont.innerHTML = '<span class="muted">Sin productos aún.</span>'; updateTotals(); return; }
      cont.innerHTML = '';
      for (const item of carro){
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <div>
            <div class="title-sm">${item.nombre}</div>
            <div class="muted">${fmt.format(item.precio)}</div>
          </div>
          <div class="qty">
            <button onclick="decQty('${item.idProd}')">−</button>
            <strong>${item.qty}</strong>
            <button onclick="incQty('${item.idProd}')">+</button>
          </div>
          <div class="right"><strong>${fmt.format(item.precio*item.qty)}</strong></div>`;
        cont.appendChild(row);
      }
      updateTotals();
    }

    function incQty(id){ const it = carro.find(x=>x.idProd===id); if(!it) return; it.qty++; renderCarro(); }
    function decQty(id){
      const it = carro.find(x=>x.idProd===id); if(!it) return;
      it.qty--; if (it.qty<=0) carro = carro.filter(x=>x.idProd!==id);
      renderCarro();
    }

    function updateTotals(){
      const ivaRate = store.get('iva',19);
      const neto = carro.reduce((s,i)=> s + i.precio*i.qty, 0);
      const iva = Math.round(neto * ivaRate/100);
      const total = neto + iva;
      $('neto').textContent = fmt.format(neto);
      $('iva').textContent = fmt.format(iva);
      $('total').textContent = fmt.format(total);
    }

    function pad(n,len=3){ return String(n).padStart(len,'0'); }

    function emitir(){
      if (carro.length===0) { alert('Agrega productos al carro.'); return; }
      const ventas = store.get('ventas',[]);
      const next = store.get('nextCorrelativo',100);
      const correlativo = next + 1;
      const ivaRate = store.get('iva',19);
      const neto = carro.reduce((s,i)=> s + i.precio*i.qty, 0);
      const iva = Math.round(neto * ivaRate/100);
      const total = neto + iva;
      const venta = {
        correlativo: correlativo,
        fecha: new Date().toISOString().slice(0,16).replace('T',' '),
        cliente: ($('cliente').value||'Consumidor Final'),
        items: carro.map(i=>({nombre:i.nombre, precio:i.precio, cantidad:i.qty})),
        neto, iva, total, ivaRate
      };
      ventas.push(venta);
      store.set('ventas', ventas);
      store.set('nextCorrelativo', correlativo);

      renderReceipt(venta);
      window.print();
      nuevaVenta();
    }

    function nuevaVenta(){
      carro = [];
      $('cliente').value='';
      updateTotals();
      renderCarro();
    }

    function renderReceipt(v){
      const lines = v.items.map(i=>`
        <tr>
          <td>${i.nombre}</td>
          <td class="right">${fmt.format(i.precio)}</td>
          <td class="right">${i.cantidad}</td>
          <td class="right">${fmt.format(i.precio*i.cantidad)}</td>
        </tr>`).join('');
      $('receipt').innerHTML = `
        <h3 style="margin-top:0;">Boleta N° ${v.correlativo}</h3>
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <div><strong>Cliente:</strong> ${v.cliente}</div>
          <div><strong>Fecha:</strong> ${v.fecha}</div>
        </div>
        <table style="width:100%;border-collapse:collapse">
          <thead><tr><th style="text-align:left">Producto</th><th class="right">P. Unit</th><th class="right">Cant</th><th class="right">Subtotal</th></tr></thead>
          <tbody>${lines}</tbody>
          <tfoot>
            <tr><td colspan="3" class="right">Neto</td><td class="right">${fmt.format(v.neto)}</td></tr>
            <tr><td colspan="3" class="right">IVA (${v.ivaRate}%)</td><td class="right">${fmt.format(v.iva)}</td></tr>
            <tr><td colspan="3" class="right">Total</td><td class="right">${fmt.format(v.total)}</td></tr>
          </tfoot>
        </table>
        <p class="muted" style="font-size:12px">Documento no válido como boleta electrónica del SII. Uso interno.</p>
      `;
      $('printable').classList.remove('hidden');
      setTimeout(()=> $('printable').classList.add('hidden'), 1000);
    }

    // HISTORIAL
    function renderHistorial(){
      const q = ($('buscarHist').value||'').toLowerCase();
      const ventas = store.get('ventas',[]).filter(v =>
        v.cliente.toLowerCase().includes(q) || String(v.correlativo).includes(q)
      ).sort((a,b)=> b.correlativo - a.correlativo);
      const cont = $('historial');
      cont.innerHTML = '';
      for (const v of ventas){
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div>
            <div class="title-sm">Boleta N° ${v.correlativo} — ${v.fecha}</div>
            <div class="muted">Cliente: ${v.cliente} · Total: ${fmt.format(v.total)}</div>
          </div>
          <button class="pill-btn" onclick="abrirBoleta(${v.correlativo})">Ver</button>`;
        cont.appendChild(div);
      }
    }

    function abrirBoleta(correlativo){
      const v = store.get('ventas',[]).find(x=>x.correlativo===correlativo);
      if (!v) return;
      renderReceipt(v);
      window.scrollTo({top:0,behavior:'smooth'});
      window.print();
    }

    // PRODUCTOS
    function renderCatalogo(){
      const cont = $('catalogo');
      const productos = store.get('productos',[]);
      cont.innerHTML = '';
      for (const p of productos){
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div>
            <div class="title-sm">${p.nombre}</div>
            <div class="muted">${fmt.format(p.precio)}</div>
          </div>
          <div class="btns">
            <button class="pill-btn" onclick="editarProducto('${p.id}')">Editar</button>
            <button class="pill-btn ghost" onclick="eliminarProducto('${p.id}')">Eliminar</button>
          </div>`;
        cont.appendChild(div);
      }
    }

    function agregarProducto(){
      const nombre = ($('prod-nombre').value||'').trim();
      const precio = Number($('prod-precio').value||'0');
      if (!nombre || !(precio>=0)) { alert('Completa nombre y precio.'); return; }
      const productos = store.get('productos',[]);
      productos.push({id:crypto.randomUUID(), nombre, precio});
      store.set('productos', productos);
      $('prod-nombre').value=''; $('prod-precio').value='';
      renderCatalogo(); renderListaProductos();
    }
    function cancelNuevo(){ $('prod-nombre').value=''; $('prod-precio').value=''; }
    function editarProducto(id){
      const productos = store.get('productos',[]);
      const p = productos.find(x=>x.id===id); if (!p) return;
      const nuevo = prompt('Nuevo precio para '+p.nombre, p.precio);
      if (nuevo===null) return;
      const val = Number(nuevo); if (!(val>=0)) return alert('Precio inválido');
      p.precio = val; store.set('productos', productos);
      renderCatalogo(); renderListaProductos();
    }
    function eliminarProducto(id){
      const productos = store.get('productos',[]).filter(x=>x.id!==id);
      store.set('productos', productos);
      renderCatalogo(); renderListaProductos();
    }

    // Start
    init();
  </script>
</body>
</html>
